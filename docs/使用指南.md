# WordPress 文章生成器 - 使用指南

完整的自动化文章生成系统，使用 OpenAI API 生成内容并通过 WordPress REST API 发布。

---

## 目录

1. [快速开始](#快速开始)
2. [安装配置](#安装配置)
3. [WordPress 配置](#wordpress-配置)
4. [OpenAI 配置](#openai-配置)
5. [命令行使用](#命令行使用)
6. [编程接口](#编程接口)
7. [配置说明](#配置说明)
8. [断点续传](#断点续传)
9. [常见问题](#常见问题)
10. [成本估算](#成本估算)

---

## 快速开始

### 第一步：安装依赖

```bash
cd /Users/guobinli/xm/wenzhang
pip install -r requirements.txt
```

### 第二步：配置文件

复制并编辑配置文件：

```bash
cp config/config.yaml config/config.local.yaml
```

编辑 `config.local.yaml`，填入你的凭据：

```yaml
wordpress:
  base_url: "https://your-site.com/wp-json"
  credentials:
    username: "your_username"
    application_password: "your_app_password"

openai:
  api_key: "sk-your-api-key-here"
  model: "gpt-4o"
```

### 第三步：测试连接

```bash
python scripts/run.py --config config/config.local.yaml --test-connection
```

### 第四步：生成文章

```bash
# 使用示例话题
python scripts/run.py --config config/config.local.yaml --test-mode

# 使用话题文件
python scripts/run.py --config config/config.local.yaml --topics-file data/keywords.csv
```

---

## 安装配置

### 系统要求

- Python 3.8 或更高版本
- WordPress 网站支持 REST API
- OpenAI API 密钥
- 稳定的网络连接

### 安装步骤

1. **安装 Python 依赖**

```bash
pip install -r requirements.txt
```

核心依赖：
- `openai>=1.12.0` - OpenAI API 客户端
- `aiohttp>=3.9.0` - 异步 HTTP 请求
- `PyYAML>=6.0.1` - 配置文件解析
- `python-dotenv>=1.0.0` - 环境变量管理

2. **创建配置文件**

```bash
cp config/config.yaml config/config.local.yaml
# 或使用环境变量
cp .env.example .env
```

3. **准备话题列表**

创建 `data/keywords.csv`：

```csv
机器学习入门
Web 开发最佳实践
2026年云计算趋势
网络安全基础
Python 数据科学
```

---

## WordPress 配置

### 获取 Application Password

1. 登录 WordPress 后台
2. 进入 **用户 > 个人资料**
3. 滚动到 **应用程序密码** 部分
4. 输入名称（如"文章生成器"）
5. 点击 **添加新的应用程序密码**
6. 复制生成的密码（格式：`xxxx xxxx xxxx xxxx xxxx xxxx`）

### 配置参数

在 `config.yaml` 中配置：

```yaml
wordpress:
  # REST API 基础 URL
  base_url: "https://example.com/wp-json"

  # 认证凭据
  credentials:
    username: "admin"
    application_password: "abcd 1234 efgh 5678 ijkl 9012"

  # 连接设置
  timeout: 30              # 请求超时（秒）
  max_connections: 10      # 最大并发连接数
  verify_ssl: true         # 验证 SSL 证书

  # 速率限制
  rate_limit:
    enabled: true
    requests_per_minute: 60  # 每分钟最多请求数
```

### 验证 WordPress 连接

```bash
python scripts/run.py --test-connection
```

成功输出：
```
Testing connections...
----------------------------------------
WordPress: ✓ Connected
OpenAI: ✓ Connected
----------------------------------------
All connections successful!
```

---

## OpenAI 配置

### 获取 API Key

1. 访问 [OpenAI Platform](https://platform.openai.com/api-keys)
2. 登录账号
3. 点击 **Create new secret key**
4. 复制生成的 API Key（格式：`sk-...`）

### 配置参数

```yaml
openai:
  api_key: "sk-proj-xxxxxxxxxxxxx"

  # 模型选择
  model: "gpt-4o"  # 可选: gpt-4o, gpt-4-turbo-preview, gpt-3.5-turbo

  # 生成参数
  max_tokens: 2500          # 最大生成长度
  temperature: 0.7          # 创造性程度 (0-2)
  top_p: 1.0                # 核采样参数
  presence_penalty: 0.0     # 存在惩罚 (-2 到 2)
  frequency_penalty: 0.0    # 频率惩罚 (-2 到 2)
```

### 模型对比

| 模型 | 特点 | 成本 | 速度 |
|------|------|------|------|
| `gpt-4o` | 最新最快，性价比高 | $5/1M tokens | 快 |
| `gpt-4-turbo-preview` | 高质量输出 | $10/1M tokens | 中 |
| `gpt-3.5-turbo` | 经济实惠 | $0.5/1M tokens | 最快 |

---

## 命令行使用

### 基础命令

#### 1. 测试连接

```bash
python scripts/run.py --test-connection
```

#### 2. 生成单篇文章（测试模式）

```bash
python scripts/run.py --test-mode --topic "人工智能入门"
```

#### 3. 批量生成文章

```bash
# 使用配置文件中的话题
python scripts/run.py

# 使用自定义话题
python scripts/run.py --topic "机器学习" --topic "深度学习"

# 使用话题文件
python scripts/run.py --topics-file data/keywords.csv
```

#### 4. 指定写作风格

```bash
python scripts/run.py --tone casual
```

可选风格：
- `professional` - 专业商务
- `casual` - 轻松随意
- `friendly` - 友好亲切
- `technical` - 技术专业
- `marketing` - 营销推广

### 会话管理

#### 列出所有会话

```bash
python scripts/run.py --list-sessions
```

输出示例：
```
Available sessions:
================================================================================

[1] Session ID: 20240115_143022
    File:        data/state/20240115_143022.json
    Started:     2024-01-15T14:30:22
    Last Update: 2024-01-15T15:45:30
    Progress:    45/100 (45.0%)
    Status:      40 completed, 5 failed

[2] Session ID: 20240114_091155
    File:        data/state/20240114_091155.json
    Started:     2024-01-14T09:11:55
    Last Update: 2024-01-14T10:20:00
    Progress:    100/100 (100.0%)
    Status:      98 completed, 2 failed
```

#### 恢复中断的会话

```bash
python scripts/run.py --resume --session-id 20240115_143022
```

或使用专用恢复脚本：

```bash
python scripts/resume.py --list
python scripts/resume.py --session-id 20240115_143022
```

#### 重试失败的文章

```bash
python scripts/run.py --retry-failed --session-id 20240115_143022
```

### 高级选项

#### 使用自定义配置文件

```bash
python scripts/run.py --config /path/to/custom-config.yaml
```

#### 指定会话 ID

```bash
# 创建新会话时指定 ID
python scripts/run.py --session-id my_custom_session
```

#### 验证已发布的文章

```bash
python scripts/run.py --verify --session-id 20240115_143022
```

---

## 编程接口

### 基础用法

```python
import asyncio
from src.article_generator import generate_articles

async def main():
    # 最简单的用法
    result = await generate_articles(
        config_path="config/config.yaml",
        tone="professional"
    )

    print(f"成功生成: {result['successful']} 篇")
    print(f"失败: {result['failed']} 篇")
    print(f"使用 tokens: {result['token_usage'].total_tokens}")

asyncio.run(main())
```

### 指定话题列表

```python
import asyncio
from src.article_generator import generate_articles

async def main():
    topics = [
        "Python 异步编程指南",
        "Docker 容器化部署",
        "React 性能优化技巧"
    ]

    result = await generate_articles(
        config_path="config/config.yaml",
        topics=topics,
        tone="technical"
    )

asyncio.run(main())
```

### 使用 Generator 类

```python
import asyncio
from src.article_generator import ArticleGenerator

async def main():
    # 创建生成器实例
    generator = ArticleGenerator("config/config.yaml")

    # 初始化
    await generator.initialize(
        session_id="my_session",
        topics=["话题1", "话题2", "话题3"]
    )

    # 生成文章
    result = await generator.generate(
        tone="professional",
        retry_failed=True
    )

    # 查看结果
    print(f"会话 ID: {result['session_id']}")
    print(f"成功: {result['successful']}")
    print(f"失败: {result['failed']}")

asyncio.run(main())
```

### 生成单篇文章

```python
import asyncio
from src.article_generator import ArticleGenerator

async def main():
    generator = ArticleGenerator("config/config.yaml")

    # 生成单篇文章
    result = await generator.generate_single(
        topic="Docker 入门教程",
        tone="casual",
        publish=True  # 是否发布到 WordPress
    )

    if result.success:
        print(f"文章已发布: {result.wordpress_url}")
        print(f"WordPress ID: {result.wordpress_id}")
    else:
        print(f"生成失败: {result.error_message}")

asyncio.run(main())
```

### 自定义 AI 配置

```python
import asyncio
from src.article_generator import ArticleGenerator
from src.ai_generator import GenerationConfig

async def main():
    # 创建自定义生成配置
    gen_config = GenerationConfig(
        model="gpt-4o",
        max_tokens=3000,
        temperature=0.8,
        min_word_count=800,
        max_word_count=2000,
        user_prompt_template="写一篇关于 {topic} 的深度分析文章"
    )

    generator = ArticleGenerator("config/config.yaml")
    generator.ai_generator.config = gen_config

    await generator.initialize(topics=["AI 技术趋势"])
    result = await generator.generate()

asyncio.run(main())
```

---

## 配置说明

### 完整配置文件示例

```yaml
# WordPress 配置
wordpress:
  base_url: "https://your-site.com/wp-json"
  credentials:
    username: "your_username"
    application_password: "your_app_password"
  timeout: 30
  max_connections: 10
  verify_ssl: true
  rate_limit:
    enabled: true
    requests_per_minute: 60

# OpenAI 配置
openai:
  api_key: "sk-your-api-key-here"
  model: "gpt-4o"
  max_tokens: 2500
  temperature: 0.7
  top_p: 1.0
  presence_penalty: 0.0
  frequency_penalty: 0.0

# 文章生成设置
generation:
  batch_size: 10
  max_concurrent: 5          # 并发生成数量
  min_word_count: 500        # 最小字数
  max_word_count: 1500       # 最大字数
  show_progress: true        # 显示进度条
  live_progress: false       # 实时进度显示
  update_interval: 1.0       # 更新间隔（秒）
  checkpoint_interval: 10    # 保存状态间隔（篇数）

# 内容设置
content:
  default_status: "draft"    # draft, publish, pending
  auto_publish: false
  generate_excerpt: true
  default_tone: "professional"

# 数据目录
data_dir: "data"

# 话题列表
topics:
  - "机器学习入门指南"
  - "Web 开发最佳实践"
  - "云计算架构设计"
```

### 环境变量配置

创建 `.env` 文件：

```bash
# WordPress
WP_BASE_URL=https://your-site.com/wp-json
WP_USERNAME=your_username
WP_APPLICATION_PASSWORD=your_app_password

# OpenAI
OPENAI_API_KEY=sk-your-api-key-here
OPENAI_MODEL=gpt-4o

# 可选设置
MAX_CONCURRENT=5
CHECKPOINT_INTERVAL=10
```

在代码中加载：

```python
from dotenv import load_dotenv
load_dotenv()
```

---

## 断点续传

### 工作原理

系统每生成 N 篇文章（默认 10 篇）会自动保存状态到 `data/state/` 目录。如果程序中断，可以从中断处继续。

### 状态文件结构

```json
{
  "total_tasks": 100,
  "completed_tasks": 45,
  "failed_tasks": 3,
  "skipped_tasks": 0,
  "started_at": "2024-01-15T14:30:22",
  "last_updated": "2024-01-15T15:45:30",
  "current_checkpoint": 5,
  "tasks": [
    {
      "topic": "机器学习入门",
      "status": "completed",
      "wordpress_id": 12345,
      "wordpress_url": "https://example.com/machine-learning-intro",
      "error_message": null,
      "retry_count": 0,
      "created_at": "2024-01-15T14:30:25",
      "completed_at": "2024-01-15T14:32:10"
    },
    {
      "topic": "云计算架构",
      "status": "failed",
      "wordpress_id": null,
      "wordpress_url": null,
      "error_message": "Rate limit exceeded",
      "retry_count": 1,
      "created_at": "2024-01-15T14:35:00",
      "completed_at": null
    }
  ]
}
```

### 恢复会话

#### 方法一：使用 run.py

```bash
# 1. 列出所有会话
python scripts/run.py --list-sessions

# 2. 恢复指定会话
python scripts/run.py --resume --session-id 20240115_143022
```

#### 方法二：使用 resume.py

```bash
# 列出会话
python scripts/resume.py --list

# 恢复会话
python scripts/resume.py --session-id 20240115_143022

# 只重试失败的任务
python scripts/resume.py --session-id 20240115_143022 --retry-failed
```

#### 方法三：编程方式

```python
import asyncio
from src.article_generator import ArticleGenerator

async def main():
    generator = ArticleGenerator("config/config.yaml")

    # 恢复会话
    result = await generator.resume_session("20240115_143022")

    print(f"恢复完成: {result['successful']} 篇成功")

asyncio.run(main())
```

### 重试失败任务

失败的文章会自动重试最多 3 次。3 次失败后标记为永久失败。

手动重试：

```bash
python scripts/run.py --retry-failed --session-id 20240115_143022
```

---

## 常见问题

### Q1: WordPress 连接失败

**错误信息：** `Failed to connect to WordPress. Check your credentials.`

**解决方案：**

1. 确认 Application Password 正确
2. 检查用户名是否正确
3. 确保 REST API 已启用
4. 测试 API 连接：

```bash
curl -u username:password https://your-site.com/wp-json/wp/v2/users/me
```

### Q2: OpenAI API 错误

**错误信息：** `Authentication failed: Incorrect API key provided`

**解决方案：**

1. 确认 API Key 正确（以 `sk-` 开头）
2. 检查 API Key 是否有余额
3. 确认 API Key 有访问权限
4. 测试 API Key：

```bash
curl https://api.openai.com/v1/models \
  -H "Authorization: Bearer $OPENAI_API_KEY"
```

### Q3: 速率限制错误

**错误信息：** `Rate limit exceeded, need to back off`

**解决方案：**

调整配置：

```yaml
generation:
  max_concurrent: 3  # 减少并发数

wordpress:
  rate_limit:
    requests_per_minute: 30  # 降低请求频率
```

### Q4: 内存占用过高

**解决方案：**

1. 减少 `batch_size`
2. 降低 `max_concurrent`
3. 分批处理话题

```bash
# 分批处理
head -50 data/keywords.csv > keywords_batch1.csv
python scripts/run.py --topics-file keywords_batch1.csv
```

### Q5: 文章质量不满意

**解决方案：**

1. 调整 temperature 参数

```yaml
openai:
  temperature: 0.9  # 更有创造性
```

2. 自定义提示词模板

```yaml
prompts:
  user_prompt_template: |
    写一篇关于 {topic} 的专业文章，要求：
    - 结构清晰，包含小标题
    - 提供实际案例
    - 字数在 1000-1500 字
    - 适合技术爱好者阅读
```

3. 尝试不同模型

```yaml
openai:
  model: "gpt-4-turbo-preview"  # 更高质量
```

### Q6: SSL 证书验证失败

**解决方案：**

```yaml
wordpress:
  verify_ssl: false  # 仅用于测试环境
```

---

## 成本估算

### OpenAI API 定价（2024年）

| 模型 | 输入 | 输出 | 平均每篇文章 |
|------|------|------|-------------|
| GPT-4o | $2.50/1M tokens | $10/1M tokens | ~$0.05 |
| GPT-4-turbo | $10/1M tokens | $30/1M tokens | ~$0.15 |
| GPT-3.5-turbo | $0.50/1M tokens | $1.50/1M tokens | ~$0.01 |

### 计算示例

生成 1000 篇文章，每篇 1500 字：

```
预估 tokens: 1000 篇 × 2000 tokens/篇 = 2,000,000 tokens

GPT-4o 成本:
- 输入: 2M × $2.50/1M = $5
- 输出: 2M × $10/1M = $20
- 总计: ~$25

GPT-4-turbo 成本:
- 输入: 2M × $10/1M = $20
- 输出: 2M × $30/1M = $60
- 总计: ~$80

GPT-3.5-turbo 成本:
- 输入: 2M × $0.50/1M = $1
- 输出: 2M × $1.50/1M = $3
- 总计: ~$4
```

### 节省成本技巧

1. **使用 GPT-3.5-turbo**：适合简单话题
2. **降低 max_tokens**：减少生成长度
3. **批量 API**：OpenAI 提供批量 API 折扣
4. **缓存结果**：避免重复生成相同话题

---

## 高级技巧

### 1. 自定义提示词模板

编辑 `config/prompts.yaml`：

```yaml
tones:
  professional:
    system: |
      你是一位专业的技术作家，擅长编写深入浅出的技术文章。
      文章结构包括：引言、核心概念、实践案例、总结。

  seo_focused:
    system: |
      你是一位 SEO 优化专家，创作内容时：
      - 自然融入关键词
      - 使用清晰的结构化标题
      - 每段开头包含主题句
      - 文末包含行动号召
```

### 2. 多语言支持

```python
result = await generator.generate_single(
    topic="人工智能",
    tone="professional"
)
```

在提示词中指定语言：

```yaml
prompts:
  user_prompt_template: "写一篇关于 {topic} 的中文技术文章"
```

### 3. 批量生成分类文章

```python
categories = {
    "技术": ["Python", "JavaScript", "Docker"],
    "营销": ["SEO", "内容营销", "社交媒体"],
    "管理": ["项目管理", "团队协作", "敏捷开发"]
}

for category, topics in categories.items():
    for topic in topics:
        await generator.generate_single(
            topic=f"{category}: {topic}",
            tone="professional"
        )
```

### 4. 定时任务

```python
import schedule
import time

def job():
    asyncio.run(generate_articles())

# 每天凌晨 2 点运行
schedule.every().day.at("02:00").do(job)

while True:
    schedule.run_pending()
    time.sleep(60)
```

---

## 附录

### 项目文件说明

| 文件 | 说明 |
|------|------|
| `src/wordpress_client.py` | WordPress REST API 客户端 |
| `src/ai_generator.py` | OpenAI 内容生成器 |
| `src/batch_processor.py` | 批量并发处理器 |
| `src/state_manager.py` | 状态持久化管理 |
| `src/progress_tracker.py` | 进度追踪器 |
| `src/rate_limiter.py` | 速率限制器 |
| `scripts/run.py` | 主执行脚本 |
| `scripts/resume.py` | 恢复脚本 |

### 日志文件

日志位置：`logs/article_generator_YYYYMMDD.log`

日志级别：
- `DEBUG`: 详细调试信息
- `INFO`: 常规信息
- `WARNING`: 警告信息
- `ERROR`: 错误信息

### 技术支持

如遇问题，请：
1. 查看日志文件
2. 运行 `--test-connection` 诊断
3. 检查配置文件格式

---

**文档版本**: 1.0
**更新日期**: 2024-01-15
